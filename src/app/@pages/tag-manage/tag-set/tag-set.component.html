<div class="pageTitle">
  <h1>標籤管理</h1>
</div>
<div class="pageContent">
  <!-- 提示訊息 -->
  <div *ngIf="this.params['changeRoute'] === 'edit' && this.validateForm.get('tagType').value ==='document'" class="noteText">
        <nb-icon icon="info-outline"></nb-icon>
        <p>重新選取檔案後，將以新版上傳資料為貼標標準</p>
  </div>
  <nb-card>
    <nb-card-header>
          <h2>{{actionName}}標籤</h2>
    </nb-card-header>
    <nb-card-body [formGroup]="validateForm">
        <div class="row">
            <basic-input class="col-12 col-lg-6" title="標籤名稱" [form]="validateForm" ctlName="tagName"></basic-input>
            <radio class="col-12 col-lg-6" title="狀態" [form]="validateForm" ctlName="status"></radio>
        </div>
        <div class="row">
            <radio class="col-12 col-lg-6" title="標籤類型" [form]="validateForm" ctlName="tagType" (valueChange)="changeTagType($event)"></radio>
            <div *ngIf="validateForm.get('tagType').value === 'normal'"  class="essential col-12 col-lg-6">
              <radio title="條件設定方式" [form]="validateForm" ctlName="setCondition" enumName="tagSetCondition"></radio>
            </div>
            <div *ngIf="validateForm.get('tagType').value === 'document'" class="fieldGroup essential col-12 col-lg-6" [ngClass]="{'error': !isFile}">
                <label>名單上傳</label>
                <div>
                    <input nbInput fullWidth [status]="isFile?'basic':'danger'" type="text" [placeholder]="fileName?fileName:'請上傳檔案'"/>
                    <input nbInput fullWidth type="file" accept = '.csv' placeholder="請上傳檔案" formControlName="uploadFile" (change)="uploadFile($event)"/>
                    <button nbButton status="warning" size="tiny" class="iconBtn">
                        <nb-icon icon="folder-add-outline"></nb-icon>
                    </button>
                </div>
                <div class="note errorText">
                    <nb-icon icon="alert-triangle"></nb-icon>
                    <p>上傳格式錯誤或檔案過大</p>
                </div>
                <div class="note">
                    <nb-icon icon="alert-circle"></nb-icon>
                    <p>請上傳csv格式檔案</p>
                </div>
            </div>
        </div>
        <date-range [form]="validateForm"></date-range>
        <div class="row">
            <dropdown class="col-12 col-lg-6" title="標籤構面" [form]="validateForm" ctlName="tagDimension"></dropdown>
            <dropdown class="col-12 col-lg-6" title="標籤子構面" [form]="validateForm" ctlName="tagSubDimension"></dropdown>
        </div>
        <div class="row">
            <dropdown class="col-12 col-lg-6" title="排程設定" [form]="validateForm" ctlName="scheduleSettings" enumName="schedule"></dropdown>
            <basic-input class="col-12 col-lg-6" title="描述說明" [form]="validateForm" ctlName="tagDescription"></basic-input>
        </div>
        <div class="subTitle">
            <p>條件設定</p>
        </div>
        <div class="row">
            <div class="fieldGroup essential col-12">
                <label>偵測條件</label>
                <!-- <div>
                    <textarea nbInput fullWidth status="basic" type="text" formControlName="conditionSettingQuery" placeholder="請輸入"></textarea>
                </div> -->
                <div>
                    <nb-select fullWidth placeholder="請選擇">
                        <nb-option value="item1">item1</nb-option>
                        <nb-option value="item2">item2</nb-option>
                    </nb-select>
                </div>
                <div class="note errorText">
                    <nb-icon icon="alert-triangle"></nb-icon>
                    <p>欄位錯誤訊息</p>
                </div>
            </div>
        </div>
        <div class="row rightBox">
          <div class="fieldBtn col-12 col-lg-2">
              <button nbButton status="control">
                  <nb-icon icon="bar-chart-outline"></nb-icon>條件分佈級距
              </button>
          </div>
        </div>
        <!-- 灰底區塊 -->
        <div class="grayCard">
          <div class="row">
              <!-- 下拉式選單欄位結構 -->
              <div class="fieldGroup essential col-6 col-lg-4">
                  <label>下拉式選單</label>
                  <div>
                      <nb-select fullWidth placeholder="請選擇">
                          <nb-option value="item1">item1</nb-option>
                          <nb-option value="item2">item2</nb-option>
                      </nb-select>
                  </div>
                  <div class="note errorText">
                      <nb-icon icon="alert-triangle"></nb-icon>
                      <p>欄位錯誤訊息</p>
                  </div>
              </div>
              <!-- 一般輸入欄位結構 -->
              <div class="fieldGroup essential col-6 col-lg-4">
                  <label>輸入欄位</label>
                  <div>
                      <input nbInput fullWidth status="basic" type="text" placeholder="請輸入" />
                  </div>
                  <div class="note errorText">
                      <nb-icon icon="alert-triangle"></nb-icon>
                      <p>欄位錯誤訊息</p>
                  </div>
              </div>
              <!-- radio欄位結構 -->
              <div class="fieldGroup col-10 col-lg-2">
                  <label>radio</label>
                  <div>
                      <nb-radio-group>
                          <nb-radio value="1">and</nb-radio>
                          <nb-radio value="2">or</nb-radio>
                      </nb-radio-group>
                  </div>
                  <!-- 欄位錯誤訊息 -->
                  <div class="note errorText">
                      <nb-icon icon="alert-triangle"></nb-icon>
                      <p>欄位錯誤訊息</p>
                  </div>
              </div>

              <!-- 增減按鈕 -->
              <div class="fieldBtn col-1 col-lg-1">
                  <button nbButton status="success" size="tiny" class="iconBtn">
                      <nb-icon icon="plus-outline"></nb-icon>
                  </button>
              </div>
              <div class="fieldBtn col-1 col-lg-1">
                  <button nbButton status="danger" size="tiny" class="iconBtn">
                      <nb-icon icon="minus-outline"></nb-icon>
                  </button>
              </div>
          </div>
        </div>
    </nb-card-body>
  </nb-card>
  <nb-card *ngIf="this.params['changeRoute'] === 'edit'">
    <nb-card-body>
        <nb-tabset>
            <nb-tab tabTitle="異動歷程">
              <div class="historyList">
                <ng-container *ngFor="let hg of detail.historyGroupView | keyvalue; let i=index;">
                    <div class="historyItem active moreBtn" [ngClass]="isHistoryOpen[hg.key] ? 'closeSubItem' : ''" *ngIf="hg.value as history;">
                        <div class="mainItem">
                            <h4 (click)="isHistoryOpen[hg.key] = !isHistoryOpen[hg.key]">{{history.type}}</h4>
                            <button nbButton status="control" size="tiny" class="iconBtn" (click)="isHistoryOpen[hg.key] = !isHistoryOpen[hg.key]">
                                <nb-icon icon="chevron-down-outline"></nb-icon>
                            </button>
                        </div>
                        <div class="subItem" [ngClass]="isHistoryOpen[hg.key] ? '' : 'displayNone'" *ngFor="let flow of history.flows">
                            <div>
                                <p>{{flow.time | date:dateFormat}}</p>
                                <p>{{flow.time | date:'hh:mm:ss'}}</p>
                            </div>
                            <div>
                                <p>{{flow.title}}</p>
                                <p>{{flow.detail}}</p>
                            </div>
                        </div>
                    </div>
                </ng-container>
              </div>
            </nb-tab>
            <nb-tab tabTitle="標籤使用範圍">
                <ng2-smart-table [settings]="gridDefine" [source]="dataSource"></ng2-smart-table>
                <paginator [source]="dataSource" [paginator]="paginator"></paginator>
            </nb-tab>
        </nb-tabset>
    </nb-card-body>
  </nb-card>
  <div class="row">
      <div class="btnGroup">
          <button nbButton status="basic" size="medium" (click)="cancel()">取消</button>
          <button nbButton status="primary" size="medium" (click)="submit()" [disabled]="validateForm.invalid">送出</button>
      </div>
  </div>
</div>
